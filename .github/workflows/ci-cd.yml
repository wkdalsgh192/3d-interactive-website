name: CI/CD - Build, Push, Deploy

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ---------- Frontend CI ----------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      - name: Build frontend
        working-directory: ./frontend
        run: CI=false npm run build

      # ---------- Backend CI ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Run backend tests
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pytest

  deploy:
    name: Continuous Deployment
    runs-on: ubuntu-latest
    needs: ci         # ensures CI must succeed first
    steps:
      - uses: actions/checkout@v4

      # ---------- Authenticate with GitHub Container Registry ----------
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}      
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # ---------- Build & push images ----------
      - name: Build and push frontend image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/frontend:latest ./frontend
          docker push ghcr.io/${{ github.repository }}/frontend:latest

      - name: Build and push backend image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/backend:latest ./backend
          docker push ghcr.io/${{ github.repository }}/backend:latest

      # ---------- Deploy on EC2 ----------
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            sudo docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
            sudo docker pull ghcr.io/${{ github.repository }}/frontend:latest
            sudo docker pull ghcr.io/${{ github.repository }}/backend:latest

            if [ ! -d "/home/ubuntu/3d-interactive-website" ]; then
              cd /home/ubuntu
              git clone https://github.com/${{ github.repository }} 3d-interactive-website
            fi

            cd /home/ubuntu/3d-interactive-website
            git pull origin master
            sudo docker compose down || true
            sudo docker compose up -d
            sudo docker image prune -f
